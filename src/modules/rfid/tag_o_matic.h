/**
 * @file tag_o_matic.h
 * @author Rennan Cockles (https://github.com/rennancockles)
 * @brief Read and Write RFID tags
 * @version 0.1
 * @date 2024-07-17
 */

#include "mfrc522_i2c.h"
#include <Wire.h>
#include "core/globals.h"


struct PrintableUID{
	String uid;
	String bcc;
	String sak;
	String atqa;
	String picc_type;
};

class TagOMatic {
public:
	enum RFID_State {
    READ_MODE,
		WRITE_MODE,
    LOAD_MODE,
    SAVE_MODE
  };

  MFRC522 mfrc522 = MFRC522(0x28);


	/////////////////////////////////////////////////////////////////////////////////////
	// Constructor
	/////////////////////////////////////////////////////////////////////////////////////
	TagOMatic();

	/////////////////////////////////////////////////////////////////////////////////////
	// Arduino Life Cycle
	/////////////////////////////////////////////////////////////////////////////////////
	void setup();
	void loop();

private:
	bool _read_uid = false;
  RFID_State current_state;
	MFRC522::Uid uid;
	PrintableUID printableUID;

	/////////////////////////////////////////////////////////////////////////////////////
	// Display functions
	/////////////////////////////////////////////////////////////////////////////////////
  void cls();
  void display_banner();
	void dump_card_details();

	/////////////////////////////////////////////////////////////////////////////////////
	// State management
	/////////////////////////////////////////////////////////////////////////////////////
	void select_state();
  void set_state(RFID_State state);

	/////////////////////////////////////////////////////////////////////////////////////
	// Operations
	/////////////////////////////////////////////////////////////////////////////////////
	void read_card();
	void write_card();
	void save_uid();
	void load_uid();

	/////////////////////////////////////////////////////////////////////////////////////
	// Helpers
	/////////////////////////////////////////////////////////////////////////////////////
  bool write_file(String filename);
  bool load_from_file();
  void parse_data();
  String get_string_uid(MFRC522::Uid *_uid);
};
